name: Deploy to Raspberry Pi

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: # Pozwala na rÄ™czne uruchomienie
  pull_request:
    branches: [ main, master ]
    types: [ closed ] # Deploy tylko gdy PR jest zamkniÄ™ty (merged)

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to Raspberry Pi via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.RASPBERRY_PI_HOST }}
        username: ${{ secrets.RASPBERRY_PI_USER }}
        key: ${{ secrets.RASPBERRY_PI_SSH_KEY }}
        port: ${{ secrets.RASPBERRY_PI_PORT || 22 }}
        script: |
          set -e
          
          echo "ğŸš€ Starting deployment to Raspberry Pi..."
          
          # PrzejdÅº do katalogu aplikacji
          cd ~/openfolio || (mkdir -p ~/openfolio && cd ~/openfolio)
          
          # Zatrzymaj aplikacjÄ™ PM2
          pm2 stop openfolio || true
          
          # Pobierz najnowszy kod
          if [ -d .git ]; then
            echo "ğŸ“¥ Pulling latest changes..."
            git fetch origin
            git reset --hard origin/main || git reset --hard origin/master
          else
            echo "ğŸ“¥ Cloning repository..."
            git clone https://github.com/${{ github.repository }}.git .
          fi
          
          # Zainstaluj zaleÅ¼noÅ›ci
          echo "ğŸ“¦ Installing dependencies..."
          npm install --legacy-peer-deps --force --no-audit --no-fund
          
          # Zbuduj aplikacjÄ™
          echo "ğŸ”¨ Building application..."
          npm run build
          
          # Uruchom aplikacjÄ™ z PM2
          echo "â–¶ï¸ Starting application..."
          pm2 start npm --name "openfolio" -- start || pm2 restart openfolio
          
          # Zapisz konfiguracjÄ™ PM2
          pm2 save
          
          # WyczyÅ›Ä‡ cache npm (opcjonalnie)
          npm cache clean --force || true
          
          echo "âœ… Deployment completed successfully!"
          echo "ğŸ“Š Application status:"
          pm2 status openfolio

