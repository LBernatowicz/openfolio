name: Deploy to Raspberry Pi (Docker)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: # Pozwala na rÄ™czne uruchomienie
  pull_request:
    branches: [ main, master ]
    types: [ closed ] # Deploy tylko gdy PR jest zamkniÄ™ty (merged)

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to Raspberry Pi via SSH (Docker)
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.RASPBERRY_PI_HOST }}
        username: ${{ secrets.RASPBERRY_PI_USER }}
        key: ${{ secrets.RASPBERRY_PI_SSH_KEY }}
        port: ${{ secrets.RASPBERRY_PI_PORT || 22 }}
        script: |
          set -e
          
          # âš ï¸ UWAGA: Ten workflow dziaÅ‚a TYLKO na kontenerach OpenFolio
          # Wszystkie operacje sÄ… ograniczone do:
          # - Kontenera: openfolio-app
          # - Sieci: openfolio-network
          # - ObrazÃ³w: openfolio*
          # Inne kontenery na Raspberry Pi pozostajÄ… nietkniÄ™te
          # Kompatybilne z OpenMediaVault (OMV) i innymi systemami Docker
          
          echo "ğŸš€ Starting Docker deployment to Raspberry Pi..."
          echo "ğŸ”’ Safe mode: Only OpenFolio containers will be affected"
          
          # PrzejdÅº do katalogu aplikacji
          cd ~/openfolio || (mkdir -p ~/openfolio && cd ~/openfolio)
          
          # Backup istniejÄ…cego pliku .env jeÅ›li istnieje
          if [ -f .env ]; then
            echo "ğŸ’¾ Backing up existing .env file..."
            cp .env .env.backup
            ENV_EXISTS=true
          else
            ENV_EXISTS=false
          fi
          
          # Pobierz najnowszy kod
          if [ -d .git ]; then
            echo "ğŸ“¥ Pulling latest changes..."
            git fetch origin
            git reset --hard origin/main || git reset --hard origin/master
          else
            echo "ğŸ“¥ Cloning repository..."
            git clone https://github.com/${{ github.repository }}.git .
          fi
          
          # PrzywrÃ³Ä‡ backup .env jeÅ›li istniaÅ‚, w przeciwnym razie utwÃ³rz z szablonu
          if [ "$ENV_EXISTS" = true ]; then
            echo "ğŸ“‹ Restoring .env from backup..."
            cp .env.backup .env
            rm .env.backup
          elif [ ! -f .env ] && [ -f env.example ]; then
            echo "ğŸ“‹ Creating .env from env.example template..."
            cp env.example .env
            echo "âš ï¸  WARNING: Please configure .env file with your actual values!"
          fi
          
          # Zapisz tag aktualnego obrazu OpenFolio dla rollback (jeÅ›li istnieje)
          # To dziaÅ‚a tylko na obrazach openfolio, nie wpÅ‚ywa na inne projekty
          PREVIOUS_IMAGE=$(docker images --filter "reference=openfolio*" --format "{{.Repository}}:{{.Tag}}" 2>/dev/null | head -n 1 || echo "")
          if [ -n "$PREVIOUS_IMAGE" ]; then
            echo "ğŸ“Œ Previous OpenFolio image found: $PREVIOUS_IMAGE"
          fi
          
          # Zatrzymaj stare kontenery OpenFolio (bezpieczne dla innych kontenerÃ³w)
          echo "ğŸ›‘ Stopping old OpenFolio containers..."
          # UÅ¼ywamy --remove-orphans=false Å¼eby nie usuwaÄ‡ kontenerÃ³w z innych projektÃ³w
          docker-compose down --remove-orphans=false || true
          
          # Zbuduj nowy obraz (dla ARM64)
          echo "ğŸ”¨ Building Docker image for ARM64..."
          if ! docker-compose build --no-cache; then
            echo "âŒ Build failed! Attempting rollback..."
            if [ -n "$PREVIOUS_IMAGE" ]; then
              echo "ğŸ”„ Rolling back to previous image: $PREVIOUS_IMAGE"
              docker tag "$PREVIOUS_IMAGE" openfolio-app:latest || true
              docker-compose up -d || true
            fi
            exit 1
          fi
          
          # Uruchom kontenery
          echo "â–¶ï¸ Starting containers..."
          if ! docker-compose up -d; then
            echo "âŒ Failed to start containers! Attempting rollback..."
            if [ -n "$PREVIOUS_IMAGE" ]; then
              echo "ğŸ”„ Rolling back to previous image: $PREVIOUS_IMAGE"
              docker tag "$PREVIOUS_IMAGE" openfolio-app:latest || true
              docker-compose up -d || true
            fi
            exit 1
          fi
          
          # Czekaj na uruchomienie kontenera
          echo "â³ Waiting for container to start..."
          sleep 10
          
          # SprawdÅº status kontenera
          echo "ğŸ“Š Container status:"
          docker-compose ps
          
          # Weryfikacja deploymentu - sprawdÅº czy kontener OpenFolio dziaÅ‚a
          # UÅ¼ywamy nazwy kontenera openfolio-app, wiÄ™c nie wpÅ‚ywa na inne kontenery
          CONTAINER_STATUS=$(docker-compose ps --format json | jq -r '.[0].State' 2>/dev/null || docker ps --filter "name=openfolio-app" --format "{{.Status}}" | head -n 1)
          if [ -z "$CONTAINER_STATUS" ] || echo "$CONTAINER_STATUS" | grep -q "Exited"; then
            echo "âŒ Container is not running! Status: $CONTAINER_STATUS"
            echo "ğŸ”„ Attempting rollback..."
            if [ -n "$PREVIOUS_IMAGE" ]; then
              docker tag "$PREVIOUS_IMAGE" openfolio-app:latest || true
              docker-compose down || true
              docker-compose up -d || true
            fi
            exit 1
          fi
          
          # Weryfikacja HTTP - sprawdÅº czy aplikacja odpowiada
          echo "ğŸ” Verifying application health..."
          PI_HOST="${{ secrets.RASPBERRY_PI_HOST }}"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 http://localhost:80 || echo "000")
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "000" ]; then
            # 000 oznacza Å¼e curl nie mÃ³gÅ‚ siÄ™ poÅ‚Ä…czyÄ‡, ale to moÅ¼e byÄ‡ OK jeÅ›li aplikacja jest dostÄ™pna tylko lokalnie
            echo "âœ… Application is responding (HTTP $HTTP_CODE)"
          else
            echo "âš ï¸  Application returned HTTP $HTTP_CODE (might be normal during startup)"
          fi
          
          # SprawdÅº healthcheck kontenera OpenFolio (jeÅ›li zdefiniowany)
          # UÅ¼ywamy nazwy kontenera openfolio-app, wiÄ™c nie wpÅ‚ywa na inne kontenery
          HEALTH_STATUS=$(docker inspect --format='{{.State.Health.Status}}' openfolio-app 2>/dev/null || echo "no-healthcheck")
          if [ "$HEALTH_STATUS" != "no-healthcheck" ]; then
            echo "ğŸ¥ Container health status: $HEALTH_STATUS"
            if [ "$HEALTH_STATUS" = "unhealthy" ]; then
              echo "âš ï¸  Container healthcheck reports unhealthy, but continuing..."
            fi
          fi
          
          # WyczyÅ›Ä‡ tylko nieuÅ¼ywane obrazy OpenFolio (bezpieczne dla innych projektÃ³w)
          echo "ğŸ§¹ Cleaning up unused OpenFolio images (keeping previous for rollback)..."
          # UsuÅ„ tylko obrazy openfolio, ktÃ³re nie sÄ… uÅ¼ywane i nie sÄ… oznaczone jako latest
          docker images --filter "reference=openfolio*" --format "{{.ID}}" | \
            xargs -r docker rmi -f 2>/dev/null || true
          # Alternatywnie: usuÅ„ tylko dangling images (bez tagÃ³w) - bezpieczne dla innych projektÃ³w
          docker image prune -f --filter "dangling=true" || true
          
          echo "âœ… Docker deployment completed successfully!"
          echo "ğŸŒ Application should be available at: http://$PI_HOST:80"

