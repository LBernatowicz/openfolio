name: Deploy to Raspberry Pi (Docker)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
  pull_request:
    branches: [ main, master ]
    types: [ closed ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üîç Verify SSH connection
      uses: appleboy/ssh-action@v1.0.3
      id: verify-ssh
      with:
        host: ${{ secrets.RASPBERRY_PI_HOST }}
        username: ${{ secrets.RASPBERRY_PI_USER }}
        key: ${{ secrets.RASPBERRY_PI_SSH_KEY }}
        port: ${{ secrets.RASPBERRY_PI_PORT || 22 }}
        timeout: 30s
        script: |
          echo "‚úÖ SSH connection successful"
          echo "üìç Host: ${{ secrets.RASPBERRY_PI_HOST }}"
          echo "üë§ User: ${{ secrets.RASPBERRY_PI_USER }}"
          echo "üê≥ Docker version:"
          docker --version || echo "‚ùå Docker not found"
          echo "üê≥ Docker Compose version:"
          docker-compose --version || echo "‚ùå Docker Compose not found"
      
    - name: üìÅ Prepare directory
      uses: appleboy/ssh-action@v1.0.3
      if: success()
      with:
        host: ${{ secrets.RASPBERRY_PI_HOST }}
        username: ${{ secrets.RASPBERRY_PI_USER }}
        key: ${{ secrets.RASPBERRY_PI_SSH_KEY }}
        port: ${{ secrets.RASPBERRY_PI_PORT || 22 }}
        timeout: 30s
        script: |
          echo "üìÅ Step 1/7: Preparing directory..."
          cd ~/openfolio || (mkdir -p ~/openfolio && cd ~/openfolio && echo "‚úÖ Directory created")
          echo "‚úÖ Current directory: $(pwd)"
          
    - name: üíæ Backup .env file
      uses: appleboy/ssh-action@v1.0.3
      if: success()
      with:
        host: ${{ secrets.RASPBERRY_PI_HOST }}
        username: ${{ secrets.RASPBERRY_PI_USER }}
        key: ${{ secrets.RASPBERRY_PI_SSH_KEY }}
        port: ${{ secrets.RASPBERRY_PI_PORT || 22 }}
        timeout: 30s
        script: |
          echo "üíæ Step 2/7: Backing up .env file..."
          cd ~/openfolio
          if [ -f .env ]; then
            cp .env .env.backup
            echo "‚úÖ .env file backed up"
          else
            echo "‚ÑπÔ∏è  No .env file found (will be created from template)"
          fi
          
    - name: üì• Pull latest code
      uses: appleboy/ssh-action@v1.0.3
      if: success()
      with:
        host: ${{ secrets.RASPBERRY_PI_HOST }}
        username: ${{ secrets.RASPBERRY_PI_USER }}
        key: ${{ secrets.RASPBERRY_PI_SSH_KEY }}
        port: ${{ secrets.RASPBERRY_PI_PORT || 22 }}
        timeout: 60s
        script: |
          echo "üì• Step 3/7: Pulling latest code..."
          cd ~/openfolio
          if [ -d .git ]; then
            git fetch origin
            git reset --hard origin/main || git reset --hard origin/master
            echo "‚úÖ Code updated"
            echo "üìå Current commit: $(git rev-parse --short HEAD)"
          else
            echo "üì• Cloning repository..."
            git clone https://github.com/${{ github.repository }}.git .
            echo "‚úÖ Repository cloned"
          fi
          
    - name: üìã Setup .env file
      uses: appleboy/ssh-action@v1.0.3
      if: success()
      with:
        host: ${{ secrets.RASPBERRY_PI_HOST }}
        username: ${{ secrets.RASPBERRY_PI_USER }}
        key: ${{ secrets.RASPBERRY_PI_SSH_KEY }}
        port: ${{ secrets.RASPBERRY_PI_PORT || 22 }}
        timeout: 30s
        script: |
          echo "üìã Step 4/7: Setting up .env file..."
          cd ~/openfolio
          if [ -f .env.backup ]; then
            cp .env.backup .env
            rm .env.backup
            echo "‚úÖ .env file restored from backup"
          elif [ ! -f .env ] && [ -f env.example ]; then
            cp env.example .env
            echo "‚ö†Ô∏è  WARNING: .env created from template - please configure it!"
          else
            echo "‚ÑπÔ∏è  .env file already exists"
          fi
          
    - name: üõë Stop old containers
      uses: appleboy/ssh-action@v1.0.3
      if: success()
      with:
        host: ${{ secrets.RASPBERRY_PI_HOST }}
        username: ${{ secrets.RASPBERRY_PI_USER }}
        key: ${{ secrets.RASPBERRY_PI_SSH_KEY }}
        port: ${{ secrets.RASPBERRY_PI_PORT || 22 }}
        timeout: 60s
        script: |
          echo "üõë Step 5/7: Stopping old containers..."
          cd ~/openfolio
          docker-compose down --remove-orphans=false || echo "‚ÑπÔ∏è  No containers to stop"
          echo "‚úÖ Old containers stopped"
          
    - name: üî® Build Docker image
      uses: appleboy/ssh-action@v1.0.3
      if: success()
      with:
        host: ${{ secrets.RASPBERRY_PI_HOST }}
        username: ${{ secrets.RASPBERRY_PI_USER }}
        key: ${{ secrets.RASPBERRY_PI_SSH_KEY }}
        port: ${{ secrets.RASPBERRY_PI_PORT || 22 }}
        timeout: 30m
        script: |
          echo "üî® Step 6/7: Building Docker image..."
          cd ~/openfolio
          echo "üì¶ Building for ARM64 architecture..."
          if docker-compose build --no-cache; then
            echo "‚úÖ Docker image built successfully"
          else
            echo "‚ùå ERROR: Docker build failed"
            echo "üìã Build logs:"
            docker-compose build --no-cache 2>&1 | tail -50
            exit 1
          fi
          
    - name: ‚ñ∂Ô∏è Start containers
      uses: appleboy/ssh-action@v1.0.3
      if: success()
      with:
        host: ${{ secrets.RASPBERRY_PI_HOST }}
        username: ${{ secrets.RASPBERRY_PI_USER }}
        key: ${{ secrets.RASPBERRY_PI_SSH_KEY }}
        port: ${{ secrets.RASPBERRY_PI_PORT || 22 }}
        timeout: 60s
        script: |
          echo "‚ñ∂Ô∏è Step 7/7: Starting containers..."
          cd ~/openfolio
          if docker-compose up -d; then
            echo "‚úÖ Containers started"
          else
            echo "‚ùå ERROR: Failed to start containers"
            echo "üìã Container logs:"
            docker-compose logs --tail=50
            exit 1
          fi
          
    - name: ‚úÖ Verify deployment
      uses: appleboy/ssh-action@v1.0.3
      if: success()
      with:
        host: ${{ secrets.RASPBERRY_PI_HOST }}
        username: ${{ secrets.RASPBERRY_PI_USER }}
        key: ${{ secrets.RASPBERRY_PI_SSH_KEY }}
        port: ${{ secrets.RASPBERRY_PI_PORT || 22 }}
        timeout: 30s
        script: |
          echo "‚úÖ Verifying deployment..."
          cd ~/openfolio
          sleep 5
          echo "üìä Container status:"
          docker-compose ps
          CONTAINER_STATUS=$(docker ps --filter "name=openfolio-app" --format "{{.Status}}" | head -n 1)
          if [ -z "$CONTAINER_STATUS" ]; then
            echo "‚ùå ERROR: Container 'openfolio-app' is not running!"
            echo "üìã Container logs:"
            docker-compose logs --tail=50 openfolio
            exit 1
          else
            echo "‚úÖ Container is running: $CONTAINER_STATUS"
          fi
          echo ""
          echo "üéâ Deployment completed successfully!"
          echo "üåê Application available at: http://${{ secrets.RASPBERRY_PI_HOST }}:80"
