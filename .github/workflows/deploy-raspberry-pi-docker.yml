name: Deploy to Raspberry Pi (Docker)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
  pull_request:
    branches: [ main, master ]
    types: [ closed ]

jobs:
  verify-ssh:
    name: üîç Verify SSH Connection
    runs-on: ubuntu-latest
    steps:
    - name: üîç Check GitHub Secrets
      run: |
        echo "=========================================="
        echo "üîç Checking GitHub Secrets Configuration"
        echo "=========================================="
        if [ -z "${{ secrets.RASPBERRY_PI_HOST }}" ]; then
          echo "‚ùå ERROR: RASPBERRY_PI_HOST is not set!"
          echo "   Please add RASPBERRY_PI_HOST to GitHub Secrets"
          exit 1
        else
          echo "‚úÖ RASPBERRY_PI_HOST is set"
        fi
        
        if [ -z "${{ secrets.RASPBERRY_PI_USER }}" ]; then
          echo "‚ùå ERROR: RASPBERRY_PI_USER is not set!"
          echo "   Please add RASPBERRY_PI_USER to GitHub Secrets"
          exit 1
        else
          echo "‚úÖ RASPBERRY_PI_USER is set"
        fi
        
        if [ -z "${{ secrets.RASPBERRY_PI_SSH_KEY }}" ]; then
          echo "‚ùå ERROR: RASPBERRY_PI_SSH_KEY is not set!"
          echo "   Please add RASPBERRY_PI_SSH_KEY to GitHub Secrets"
          exit 1
        else
          echo "‚úÖ RASPBERRY_PI_SSH_KEY is set"
          # Sprawd≈∫ format klucza
          KEY_START=$(echo "${{ secrets.RASPBERRY_PI_SSH_KEY }}" | head -c 50)
          if echo "$KEY_START" | grep -q "BEGIN.*PRIVATE KEY"; then
            echo "‚úÖ SSH key format looks correct (private key)"
          elif echo "$KEY_START" | grep -q "BEGIN SSH2 PUBLIC KEY"; then
            echo "‚ùå ERROR: You provided a PUBLIC key instead of PRIVATE key!"
            echo ""
            echo "   üî¥ Problem: You're using id_ed25519.pub (PUBLIC key)"
            echo "   ‚úÖ Solution: Use id_ed25519 (PRIVATE key - without .pub)"
            echo ""
            echo "   üìã How to fix:"
            echo "   1. On your local machine, run:"
            echo "      cat ~/.ssh/id_ed25519"
            echo ""
            echo "   2. Copy the ENTIRE output (starts with -----BEGIN OPENSSH PRIVATE KEY-----)"
            echo ""
            echo "   3. Paste it into GitHub Secrets ‚Üí RASPBERRY_PI_SSH_KEY"
            echo ""
            echo "   ‚ö†Ô∏è  Important:"
            echo "   - Use id_ed25519 (PRIVATE key) - NOT id_ed25519.pub (PUBLIC key)"
            echo "   - Private key file: ~/.ssh/id_ed25519"
            echo "   - Public key file: ~/.ssh/id_ed25519.pub (this is what you're using now - WRONG!)"
            exit 1
          elif echo "$KEY_START" | grep -q "^ssh-ed25519"; then
            echo "‚ùå ERROR: You provided a PUBLIC key instead of PRIVATE key!"
            echo ""
            echo "   üî¥ Problem: You're using id_ed25519.pub (PUBLIC key)"
            echo "   ‚úÖ Solution: Use id_ed25519 (PRIVATE key - without .pub)"
            echo ""
            echo "   üìã How to fix:"
            echo "   1. On your local machine, run:"
            echo "      cat ~/.ssh/id_ed25519"
            echo ""
            echo "   2. Copy the ENTIRE output (starts with -----BEGIN OPENSSH PRIVATE KEY-----)"
            echo ""
            echo "   3. Paste it into GitHub Secrets ‚Üí RASPBERRY_PI_SSH_KEY"
            echo ""
            echo "   ‚ö†Ô∏è  Important:"
            echo "   - Use id_ed25519 (PRIVATE key) - NOT id_ed25519.pub (PUBLIC key)"
            echo "   - Private key file: ~/.ssh/id_ed25519"
            echo "   - Public key file: ~/.ssh/id_ed25519.pub (this is what you're using now - WRONG!)"
            exit 1
          else
            echo "‚ö†Ô∏è  WARNING: SSH key format might be incorrect"
            echo "   Private key should start with: -----BEGIN OPENSSH PRIVATE KEY-----"
            echo "   or: -----BEGIN RSA PRIVATE KEY-----"
          fi
        fi
        echo ""
        echo "üìç Connection details:"
        echo "   Host: ${{ secrets.RASPBERRY_PI_HOST }}"
        echo "   User: ${{ secrets.RASPBERRY_PI_USER }}"
        echo "   Port: ${{ secrets.RASPBERRY_PI_PORT || 22 }}"
        echo ""
        
    - name: üîç Test SSH connection
      uses: appleboy/ssh-action@v1.0.3
      id: ssh-test
      continue-on-error: true
      with:
        host: ${{ secrets.RASPBERRY_PI_HOST }}
        username: ${{ secrets.RASPBERRY_PI_USER }}
        key: ${{ secrets.RASPBERRY_PI_SSH_KEY }}
        port: ${{ secrets.RASPBERRY_PI_PORT || 22 }}
        timeout: 30s
        script: |
          echo "=========================================="
          echo "üîç SSH Connection Verification"
          echo "=========================================="
          echo "‚úÖ SSH connection successful!"
          echo ""
          echo "üñ•Ô∏è  System information:"
          echo "   OS: $(uname -a)"
          echo "   Uptime: $(uptime -p)"
          echo ""
          echo "üê≥ Docker information:"
          if command -v docker &> /dev/null; then
            echo "   Docker: $(docker --version)"
          else
            echo "   ‚ùå Docker not found!"
            exit 1
          fi
          if command -v docker-compose &> /dev/null; then
            echo "   Docker Compose: $(docker-compose --version)"
          else
            echo "   ‚ùå Docker Compose not found!"
            exit 1
          fi
          echo ""
          echo "üìÅ Working directory:"
          echo "   $(pwd)"
          echo ""
          echo "‚úÖ SSH verification completed successfully!"
          echo "=========================================="
          
    - name: ‚ùå SSH Connection Failed - Troubleshooting
      if: failure()
      run: |
        echo "=========================================="
        echo "‚ùå SSH Connection Failed"
        echo "=========================================="
        echo ""
        echo "üîç Common issues and solutions:"
        echo ""
        echo "1. 'ssh: no key found' error:"
        echo "   ‚ùå You provided a PUBLIC key instead of PRIVATE key"
        echo "   ‚úÖ Solution: Use the PRIVATE key in GitHub Secrets"
        echo "   üìã Private key starts with: -----BEGIN OPENSSH PRIVATE KEY-----"
        echo "   üìã Public key starts with: ssh-rsa or -----BEGIN SSH2 PUBLIC KEY-----"
        echo ""
        echo "2. 'i/o timeout' error:"
        echo "   ‚ùå GitHub Actions cannot reach your Raspberry Pi"
        echo "   ‚úÖ Solutions:"
        echo "      - If using local IP (192.168.x.x): Configure port forwarding in router"
        echo "      - Use Tailscale/ZeroTier VPN for direct access"
        echo "      - Use public IP address if available"
        echo ""
        echo "3. 'Permission denied' error:"
        echo "   ‚ùå SSH key is not authorized on Raspberry Pi"
        echo "   ‚úÖ Solution: Add public key to ~/.ssh/authorized_keys on Raspberry Pi"
        echo ""
        echo "üìö For detailed instructions, see: GITHUB-ACTIONS-DEPLOYMENT.md"
        echo "=========================================="
        exit 1

  deploy:
    name: üöÄ Deploy Application
    needs: verify-ssh
    runs-on: ubuntu-latest
    if: success()
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üìÅ Prepare directory
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.RASPBERRY_PI_HOST }}
        username: ${{ secrets.RASPBERRY_PI_USER }}
        key: ${{ secrets.RASPBERRY_PI_SSH_KEY }}
        port: ${{ secrets.RASPBERRY_PI_PORT || 22 }}
        timeout: 30s
        script: |
          echo "=========================================="
          echo "üìÅ Step 1/6: Preparing directory"
          echo "=========================================="
          cd ~/openfolio || (mkdir -p ~/openfolio && cd ~/openfolio && echo "‚úÖ Directory created")
          echo "‚úÖ Current directory: $(pwd)"
          echo ""
          
    - name: üíæ Backup .env file
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.RASPBERRY_PI_HOST }}
        username: ${{ secrets.RASPBERRY_PI_USER }}
        key: ${{ secrets.RASPBERRY_PI_SSH_KEY }}
        port: ${{ secrets.RASPBERRY_PI_PORT || 22 }}
        timeout: 30s
        script: |
          echo "=========================================="
          echo "üíæ Step 2/6: Backing up .env file"
          echo "=========================================="
          cd ~/openfolio
          if [ -f .env ]; then
            cp .env .env.backup
            echo "‚úÖ .env file backed up"
          else
            echo "‚ÑπÔ∏è  No .env file found (will be created from template)"
          fi
          echo ""
          
    - name: üì• Pull latest code
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.RASPBERRY_PI_HOST }}
        username: ${{ secrets.RASPBERRY_PI_USER }}
        key: ${{ secrets.RASPBERRY_PI_SSH_KEY }}
        port: ${{ secrets.RASPBERRY_PI_PORT || 22 }}
        timeout: 60s
        script: |
          echo "=========================================="
          echo "üì• Step 3/6: Pulling latest code"
          echo "=========================================="
          cd ~/openfolio
          if [ -d .git ]; then
            echo "üì• Fetching latest changes..."
            git fetch origin
            git reset --hard origin/main || git reset --hard origin/master
            echo "‚úÖ Code updated"
            echo "üìå Current commit: $(git rev-parse --short HEAD)"
            echo "üìå Commit message: $(git log -1 --pretty=%B)"
          else
            echo "üì• Cloning repository..."
            git clone https://github.com/${{ github.repository }}.git .
            echo "‚úÖ Repository cloned"
          fi
          echo ""
          
    - name: üìã Setup .env file
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.RASPBERRY_PI_HOST }}
        username: ${{ secrets.RASPBERRY_PI_USER }}
        key: ${{ secrets.RASPBERRY_PI_SSH_KEY }}
        port: ${{ secrets.RASPBERRY_PI_PORT || 22 }}
        timeout: 30s
        script: |
          echo "=========================================="
          echo "üìã Step 4/6: Setting up .env file"
          echo "=========================================="
          cd ~/openfolio
          if [ -f .env.backup ]; then
            cp .env.backup .env
            rm .env.backup
            echo "‚úÖ .env file restored from backup"
          elif [ ! -f .env ] && [ -f env.example ]; then
            cp env.example .env
            echo "‚ö†Ô∏è  WARNING: .env created from template - please configure it!"
          else
            echo "‚ÑπÔ∏è  .env file already exists"
          fi
          echo ""
          
    - name: üõë Stop old containers
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.RASPBERRY_PI_HOST }}
        username: ${{ secrets.RASPBERRY_PI_USER }}
        key: ${{ secrets.RASPBERRY_PI_SSH_KEY }}
        port: ${{ secrets.RASPBERRY_PI_PORT || 22 }}
        timeout: 60s
        script: |
          echo "=========================================="
          echo "üõë Step 5/6: Stopping old containers"
          echo "=========================================="
          cd ~/openfolio
          if [ -f docker-compose.yml ]; then
            docker-compose down --remove-orphans=false || echo "‚ÑπÔ∏è  No containers to stop"
            echo "‚úÖ Old containers stopped"
          else
            echo "‚ö†Ô∏è  docker-compose.yml not found"
          fi
          echo ""
          
    - name: üî® Build Docker image
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.RASPBERRY_PI_HOST }}
        username: ${{ secrets.RASPBERRY_PI_USER }}
        key: ${{ secrets.RASPBERRY_PI_SSH_KEY }}
        port: ${{ secrets.RASPBERRY_PI_PORT || 22 }}
        timeout: 30m
        script: |
          echo "=========================================="
          echo "üî® Step 6/6: Building Docker image"
          echo "=========================================="
          cd ~/openfolio
          if [ ! -f docker-compose.yml ]; then
            echo "‚ùå ERROR: docker-compose.yml not found!"
            exit 1
          fi
          echo "üì¶ Building for ARM64 architecture..."
          if docker-compose build --no-cache; then
            echo "‚úÖ Docker image built successfully"
          else
            echo "‚ùå ERROR: Docker build failed"
            echo ""
            echo "üìã Last 50 lines of build output:"
            docker-compose build --no-cache 2>&1 | tail -50
            exit 1
          fi
          echo ""
          
    - name: ‚ñ∂Ô∏è Start containers
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.RASPBERRY_PI_HOST }}
        username: ${{ secrets.RASPBERRY_PI_USER }}
        key: ${{ secrets.RASPBERRY_PI_SSH_KEY }}
        port: ${{ secrets.RASPBERRY_PI_PORT || 22 }}
        timeout: 60s
        script: |
          echo "=========================================="
          echo "‚ñ∂Ô∏è Starting containers"
          echo "=========================================="
          cd ~/openfolio
          if docker-compose up -d; then
            echo "‚úÖ Containers started"
          else
            echo "‚ùå ERROR: Failed to start containers"
            echo ""
            echo "üìã Container logs:"
            docker-compose logs --tail=50
            exit 1
          fi
          echo ""
          
    - name: ‚úÖ Verify deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.RASPBERRY_PI_HOST }}
        username: ${{ secrets.RASPBERRY_PI_USER }}
        key: ${{ secrets.RASPBERRY_PI_SSH_KEY }}
        port: ${{ secrets.RASPBERRY_PI_PORT || 22 }}
        timeout: 30s
        script: |
          echo "=========================================="
          echo "‚úÖ Verifying deployment"
          echo "=========================================="
          cd ~/openfolio
          sleep 5
          echo "üìä Container status:"
          docker-compose ps
          echo ""
          CONTAINER_STATUS=$(docker ps --filter "name=openfolio-app" --format "{{.Status}}" | head -n 1)
          if [ -z "$CONTAINER_STATUS" ]; then
            echo "‚ùå ERROR: Container 'openfolio-app' is not running!"
            echo ""
            echo "üìã Container logs:"
            docker-compose logs --tail=50 openfolio
            exit 1
          else
            echo "‚úÖ Container is running: $CONTAINER_STATUS"
          fi
          echo ""
          echo "üéâ Deployment completed successfully!"
          echo "üåê Application available at: http://${{ secrets.RASPBERRY_PI_HOST }}:80"
          echo "=========================================="
